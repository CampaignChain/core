{#
This file is part of the CampaignChain package.

(c) CampaignChain Inc. <info@campaignchain.com>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}

{% extends 'CampaignChainCoreBundle:Base:base.html.twig' %}

{% block choice_widget_collapsed %}
    {% spaceless %}
        <div id="{{ id }}">
            <script>
                $('.select2').select2({ placeholder: "Select a State", maximumSelectionSize: 6 });
                $(':checkbox').on( "click", function() {
                    $(this).parent().nextAll('select').select2("enable", this.checked );
                });
            </script>
            {% set attr = attr|merge({ 'class': (attr.class|default('') ~ ' form-control')|trim }) %}

            <select class="form-control {{ id }}-select2" {{ block('widget_attributes') }}{% if multiple %} multiple="multiple"{% endif %}>
                {% if empty_value is not none %}
                    <option></option>
                {% endif %}
                {% if preferred_choices|length > 0 %}
                    {% set options = preferred_choices %}
                    {{ block('choice_widget_options') }}
                    {% if choices|length > 0 and separator is not none %}
                        <option disabled="disabled">{{ separator }}</option>
                    {% endif %}
                {% endif %}
                {% set options = choices %}
                {{ block('choice_widget_options') }}
            </select>
            <script>
                {% if attr.show_image is defined and attr.show_image == true %}
                    function format(optionnode) {
                        if (!optionnode.id) return optionnode.text; // optgroup
                        var originalOption = optionnode.element;

                        return campaignchainTplMedium(
                                $(originalOption).data('icon'),
                                $(originalOption).data('context-icon'),
                                optionnode.text
                        );
                    }
                {% endif %}
                $('.{{ id }}-select2').select2({
                    {% if empty_value is not none %}
                        placeholder: "{{ empty_value|trans({}, translation_domain) }}", allowClear: true,
                    {% endif %}
                    {% if attr.show_image is defined and attr.show_image == true %}
                        formatResult: format,
                        formatSelection: format,
                        escapeMarkup: function(m) { return m; },
                    {% endif %}
                    {% if attr.minimum_results_for_search is defined and attr.minimum_results_for_search is not empty %}
                        {% set minimum_results_for_search = attr.minimum_results_for_search %}
                    {% else %}
                        {% set minimum_results_for_search = '5' %}
                    {% endif %}
                    minimumResultsForSearch : {{ minimum_results_for_search }}
                });
                $(':checkbox').on( "click", function() {
                    $(this).parent().nextAll('select').select2("enable", this.checked );
                });
            </script>
        </div>
    {% endspaceless %}
{% endblock choice_widget_collapsed %}

{% block choice_widget_options %}
    {% spaceless %}
        {% for group_label, choice in options %}
            {% if choice is iterable %}
                <optgroup label="{{ group_label|trans({}, translation_domain) }}">
                    {% set options = choice %}
                    {{ block('choice_widget_options') }}
                </optgroup>
            {% else %}
                <option value="{{ choice.value }}"{% if choice is selectedchoice(value) or
                    (attr.selected is defined and attr.selected == choice.value) %} selected="selected"{% endif %}
                    {% if attr.show_image is defined and attr.show_image == true %}
                        data-icon="{{ asset( choice.data|campaignchain_medium_icon ) }}"
                        data-context-icon="{{ asset( choice.data|campaignchain_medium_context ) }}"
                    {% endif %}> {{ choice.label|trans({}, translation_domain) }}
                </option>
            {% endif %}
        {% endfor %}
    {% endspaceless %}
{% endblock choice_widget_options %}

{% block daterangepicker_widget %}
    {% spaceless %}
        {% set value = data|campaignchain_datetime() %}
        {% if widget == 'single_text' %}
            {{ block('form_widget_simple') }}
        {% else %}
            {% set attr = attr|merge({ 'class': 'bootstrap-datetime' }) %}
            <div {{ block('widget_container_attributes') }}>
                {{ form_widget(form.date) }}
                {{ form_widget(form.time) }}
                {{ form_errors(form.date) }}
                {{ form_errors(form.time) }}
            </div>
        {% endif %}
        {% if attr.is_end_date is not defined or attr.is_end_date != true %}
            <script type="text/javascript">
                $(document).ready(function() {
                    // Define the start and end date elements.
                    var startElement = $('#{{ id }}');
                    var endElementId = startElement.attr('id').replace('startDate', 'endDate');
                    var endElement = $('#' + endElementId);

                    // TODO: Take hour from system setting of work day start hour.
                    var minDate = moment().hour(9).minute(0).format(window.campaignchainDatetimeFormat);

                    // TODO: If value is empty after validation error, populate it with data.
                    if(!startElement.val()){
                        {% if data is not null %}
                        var startDate = moment('{{ data|campaignchain_datetime() }}');
                        {% else %}
                        var startDate = minDate;
                        {% endif %}
                        // TODO: Take hour from system setting of work day end hour.
                        // TODO: Take range of new campaign (i.e. add('day', 1)) from system setting for default range.
                        var endDate = moment(startDate).hour(18).add('day',1);
                    } else {
                        var startDate = startElement.val();
                        var endDate = endElement.val();
                    }

                    startElement.daterangepicker(
                            {
                                startDate: startDate,
                                minDate: minDate,
                                endDate: endDate,
                                timePicker: true,
                                timePickerIncrement: 5,
                                format: window.campaignchainDatetimeFormat,
                                timePicker12Hour: false
                            },
                        function(start, end, label) {
                            console.log('startElement');
                            console.log(start);
                            console.log(end);
                            console.log('startDate: ' + start.format(window.campaignchainDatetimeFormat));
                            console.log('endDate:' + end.format(window.campaignchainDatetimeFormat));
                            // Set dates for daterangepicker of end date field.
                            endElement.data('daterangepicker').setStartDate(start.format(window.campaignchainDatetimeFormat));
                            endElement.data('daterangepicker').setEndDate(end.format(window.campaignchainDatetimeFormat));
                            // Set dates for form fields.
                            startElement.val(start.format(window.campaignchainDatetimeFormat));
                            endElement.val(end.format(window.campaignchainDatetimeFormat));
                        }
                    );

                    endElement.daterangepicker(
                            {
                                startDate: startDate,
                                minDate: minDate,
                                endDate: endDate,
                                timePicker: true,
                                timePickerIncrement: 5,
                                format: window.campaignchainDatetimeFormat,
                                timePicker12Hour: false
                            },
                            function(start, end, label) {
                                console.log('endElement');
                                console.log('startDate: ' + start.format(window.campaignchainDatetimeFormat));
                                console.log('endDate:' + end.format(window.campaignchainDatetimeFormat));
                                // Set dates for daterangepicker of start date form field.
                                startElement.data('daterangepicker').setStartDate(start.format(window.campaignchainDatetimeFormat));
                                startElement.data('daterangepicker').setEndDate(end.format(window.campaignchainDatetimeFormat));
                                // Set dates for both form fields.
                                startElement.val(start.format(window.campaignchainDatetimeFormat));
                                endElement.val(end.format(window.campaignchainDatetimeFormat));
                            }
                    );
                });
            </script>
            {% endif %}
    {% endspaceless %}
{% endblock daterangepicker_widget %}

{% block textarea_widget %}
    {% spaceless %}
        {% set col_size = col_size|default(bootstrap_get_col_size()) %}

        {% if attr.simple_col is defined and attr.simple_col is not empty %}
            {% set simple_col = attr.simple_col %}
        {% endif  %}
        {% if attr.col_size is defined and attr.col_size is not empty %}
            {% set col_size = attr.col_size %}
        {% endif %}

        {% if simple_col is defined %}
            <div class="col-{{ col_size }}-{{ simple_col }}">
        {% endif %}

        {% set attr = attr|merge({ 'class': (attr.class|default('') ~ ' form-control')|trim }) %}

        <textarea {{ block('widget_attributes') }}>{{ value }}</textarea>

        {% if attr.maxlength is defined %}
            <span id="{{ id }}_counter" class="help-block"></span>

            <script type="text/javascript">
                $(document).ready(function() {
                    var text_max = {{ attr.maxlength }};
                    var text_length = $('#{{ id }}').val().length;
                    var text_remaining = text_max - text_length;

                    $('#{{ id }}_counter').html(text_remaining + ' characters remaining');

                    $('#{{ id }}').keyup(function(event) {
                        text_length = $('#{{ id }}').val().length;
                        text_remaining = text_max - text_length;

                        $('#{{ id }}_counter').html(text_remaining + ' characters remaining');
                    });
                });
            </script>
        {% endif %}

        {% if simple_col is defined %}
            </div>
        {% endif %}
    {% endspaceless %}
{% endblock textarea_widget %}

{% block bootstrap_collection_widget %}
    {% spaceless %}
        {% if prototype is defined %}
            {% set prototype_vars = {} %}
            {% if style is defined %}
                {% set prototype_vars = prototype_vars|merge({'style': style}) %}
            {% endif %}
            {% set prototype_html = '<div class="col-xs-' ~ form.vars.sub_widget_col ~ '">' ~ form_widget(prototype, prototype_vars) ~ '</div>' %}
            {% if form.vars.allow_delete %}
                {% set prototype_html = prototype_html ~ '<div class="col-xs-' ~ form.vars.button_col ~ '"><a href="#" class="btn btn-danger btn-sm" data-removefield="collection" data-field="__id__">' ~ form.vars.delete_button_text|trans({}, translation_domain)|parse_icons|raw ~ '</a></div>' %}
            {% endif %}
            {% set prototype_html = '<div class="row">' ~ prototype_html ~ '</div>' %}

            {% set attr = attr|merge({'data-prototype': prototype_html }) %}
            {% set attr = attr|merge({'data-prototype-name': prototype_name }) %}
        {% endif %}
        <div {{ block('widget_container_attributes') }}>
            <ul class="bc-collection list-unstyled">
                {% for field in form %}
                    <li>
                        <div class="row">
                            <div class="col-xs-{{ form.vars.sub_widget_col }}">
                                {{ form_widget(field) }}
                                {{ form_errors(field) }}
                            </div>
                            {% if form.vars.allow_delete %}
                                <div class="col-xs-{{ form.vars.button_col }}">
                                    <a href="#" class="btn btn-danger btn-sm" data-removefield="collection" data-field="{{ field.vars.id }}">{{ form.vars.delete_button_text|trans({}, translation_domain)|parse_icons|raw }}</a>
                                </div>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
            {% if form.vars.allow_add %}
                <a href="#" class="btn btn-primary btn-sm" data-addfield="collection" data-collection="{{ form.vars.id }}" data-prototype-name="{{ prototype_name }}">{{ form.vars.add_button_text|trans({}, translation_domain)|parse_icons|raw }}</a>
            {% endif %}
        </div>
        {# Make sure that first field is being displayed in collection and it has no delete button. #}
        <script type="application/javascript">
            if(!$("input[data-field='{{ form.vars.id }}_0']").length) {
                $("a[data-collection='{{ form.vars.id }}']").trigger('click');
            }
            $("a[data-field='{{ form.vars.id }}_0']").hide();
        </script>
    {% endspaceless %}
{% endblock bootstrap_collection_widget %}

{% block avatar_upload_widget %}
    {% set modalContent %}
    {% set modalId = "avatar_modal_"~id %}
    {% set containerId = "avatar_upload_"~id %}
        {% include 'CampaignChainCoreBundle:Form:avatarUploadModal.html.twig' with {modalId: modalId} %}
    {% endset %}

    <div class="avatar-upload-container" id="{{ containerId }}">
        {% if data is not empty %}
            <img class="avatar-image" src="{{ data|campaignchain_user_avatar }}" alt="">
        {% else %}
            <span class="avatar-image no-avatar"></span>
        {% endif %}
        <span class="hover-text">Set Image</span>
        <input type="hidden" {{ block('widget_attributes') }} value="{{ value }}">
        <script type="application/javascript">
            $(document).ready(function() {
                var settings = {{ {
                    modalContent: modalContent,
                    containerId: containerId,
                    widgetId: id,
                    modalId: modalId,
                    gravatarDownloaderUrl: path("campaignchain_core_profile_grab_gavatar"),
                }|json_encode|raw }};
                var $container = $("#" + settings.containerId);
                var $widget = $("#" + settings.widgetId);
                var getEmail = function() {
                    // Find email input by finding an input with name ending with '[email]' and
                    // getting its value.
                    return $widget.parents('form').find('input[name$="[email]"]').val();
                };
                var updateImage = function(value, previewUrl) {
                    $container.find('.avatar-image').replaceWith($("<img class='avatar-image' alt='' />").attr({src: previewUrl}));
                    $('#'+settings.widgetId).val(value);
                };

                $container.on("click", function() {
                    var $modal = $("#campaignchain-default-modal");

                    $modal
                        .find(".modal-content")
                            .html(settings.modalContent)
                        .end()
                        .one("show.modal.bs", function() {
                            $modal.find("input[type=file]")
                                .fileupload({
                                    dataType: 'json',
                                    done: function(e, data) {
                                        var response = data.response();
                                        var result = response.result;

                                        updateImage(result.path, result.url);
                                        $modal.modal("hide");
                                    }
                                });
                        })
                        .on("click", "#"+settings.modalId+" .btn-download-gravatar", function(e) {
                            e.preventDefault();
                            $
                                .ajax({
                                    url: settings.gravatarDownloaderUrl,
                                    method: 'POST',
                                    dataType: 'json',
                                    data: {email: getEmail()}
                                })
                                .success(function(data, status, xhr) {
                                    updateImage(data.path, data.url);
                                    $modal.modal("hide");
                                });
                        })
                        .modal("show");
                });
            });
        </script>
    </div>
{% endblock %}